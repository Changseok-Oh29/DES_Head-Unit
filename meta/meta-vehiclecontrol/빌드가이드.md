# VehicleControl ECU - 빌드 가이드

## 시스템 요구사항

- Ubuntu 20.04 / 22.04 LTS
- 디스크 공간: 100GB 이상
- RAM: 8GB 이상 (16GB 권장)
- 안정적인 인터넷 연결

## 필수 패키지 설치

```bash
sudo apt-get update
sudo apt-get install gawk wget git diffstat unzip texinfo gcc build-essential \
    chrpath socat cpio python3 python3-pip python3-pexpect xz-utils \
    debianutils iputils-ping python3-git python3-jinja2 libegl1-mesa \
    libsdl1.2-dev pylint3 xterm python3-subunit mesa-common-dev zstd liblz4-tool
```

---

## 1단계: Yocto 레이어 준비

### Yocto 레이어 클론 (Kirkstone)
```bash
mkdir -p ~/yocto && cd ~/yocto

git clone -b kirkstone git://git.yoctoproject.org/poky
git clone -b kirkstone https://github.com/agherzan/meta-raspberrypi.git
git clone -b kirkstone https://github.com/openembedded/meta-openembedded.git
```

---

## 2단계: 소스 준비

VehicleControlECU 소스를 recipe로 복사:

```bash
cd /home/leo/SEA-ME/DES_Head-Unit/meta/meta-vehiclecontrol
./tools/prepare-sources.sh
```

이 스크립트는 다음을 복사합니다:
- `app/VehicleControlECU/src/` → recipe files/src/
- `app/VehicleControlECU/lib/` → recipe files/lib/
- `commonapi/generated/` → recipe files/commonapi-generated/
- CMakeLists.txt 및 설정 파일들

---

## 3단계: 빌드 환경 초기화

```bash
cd ~/yocto
source poky/oe-init-build-env build-ecu1
```

### 레이어 추가
```bash
bitbake-layers add-layer ../meta-raspberrypi
bitbake-layers add-layer ../meta-openembedded/meta-oe
bitbake-layers add-layer /home/leo/SEA-ME/DES_Head-Unit/meta/meta-vehiclecontrol
```

### 레이어 확인
```bash
bitbake-layers show-layers
```

출력 예시:
```
layer                 path                                      priority
=============================================================================
meta                  /home/user/yocto/poky/meta                5
meta-poky             /home/user/yocto/poky/meta-poky           5
meta-raspberrypi      /home/user/yocto/meta-raspberrypi         9
meta-oe               /home/user/yocto/meta-openembedded/meta-oe 6
meta-vehiclecontrol   /home/leo/.../meta-vehiclecontrol         8
```

---

## 4단계: 빌드 설정

### conf/local.conf 편집

```bash
vi conf/local.conf
```

**필수 설정:**
```bash
# 타겟 머신
MACHINE = "raspberrypi4-64"

# systemd 사용
DISTRO_FEATURES_append = " systemd"
VIRTUAL-RUNTIME_init_manager = "systemd"

# 병렬 빌드 (CPU 코어 수에 맞게 조정)
BB_NUMBER_THREADS = "8"
PARALLEL_MAKE = "-j 8"

# 디스크 공간 모니터링
BB_DISKMON_DIRS = "\
    STOPTASKS,${TMPDIR},1G,100K \
    STOPTASKS,${DL_DIR},1G,100K \
    STOPTASKS,${SSTATE_DIR},1G,100K"

# 패키지 관리
PACKAGE_CLASSES = "package_rpm"
```

**선택 사항 (이미지 최적화):**
```bash
# 불필요한 기능 제거 (더 작은 이미지)
DISTRO_FEATURES_remove = "x11 wayland pulseaudio bluetooth wifi"
```

---

## 5단계: 이미지 빌드

### 전체 이미지 빌드
```bash
bitbake vehiclecontrol-image
```

⏱️ **예상 시간**: 
- 첫 빌드: 2-4시간 (다운로드 포함)
- 재빌드: 10-30분

### 개별 패키지 빌드 (테스트용)
```bash
# vsomeip만 빌드
bitbake vsomeip

# VehicleControlECU만 빌드
bitbake vehiclecontrol-ecu

# 의존성 확인
bitbake-layers show-recipes vehiclecontrol-ecu
```

---

## 6단계: SD 카드 플래싱

### 이미지 위치 확인
```bash
cd ~/yocto/build-ecu1/tmp/deploy/images/raspberrypi4-64
ls -lh *.rpi-sdimg
```

### SD 카드 장치 확인
```bash
lsblk
```

출력 예시:
```
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda           8:0    0 238.5G  0 disk 
└─sda1        8:1    0 238.5G  0 part /
sdb           8:16   1  29.7G  0 disk    ← SD 카드
└─sdb1        8:17   1  29.7G  0 part
```

### 이미지 플래싱
```bash
# 주의: sdX를 실제 SD 카드 장치로 변경!
sudo dd if=vehiclecontrol-image-raspberrypi4-64.rpi-sdimg \
    of=/dev/sdX bs=4M status=progress && sync
```

---

## 7단계: 첫 부팅 및 확인

### 시리얼 콘솔 접속 (선택)
```bash
screen /dev/ttyUSB0 115200
```

### SSH 접속
```bash
# Raspberry Pi 부팅 후 (약 30초~1분)
ssh root@192.168.1.100
# 비밀번호: raspberry
```

### 서비스 상태 확인
```bash
# VehicleControlECU 서비스 확인
systemctl status vehiclecontrol-ecu

# 로그 확인
journalctl -u vehiclecontrol-ecu -f

# 네트워크 확인
ip addr show eth0
ip route | grep 224

# I2C 장치 확인
i2cdetect -y 1
```

---

## 개발 워크플로우

### 소스 코드 수정 후 재빌드

1. **소스 재준비**
```bash
cd /home/leo/SEA-ME/DES_Head-Unit/meta/meta-vehiclecontrol
./tools/prepare-sources.sh
```

2. **클린 빌드**
```bash
cd ~/yocto/build-ecu1
bitbake vehiclecontrol-ecu -c cleanall
bitbake vehiclecontrol-image
```

3. **빠른 재빌드 (설정만 변경된 경우)**
```bash
bitbake vehiclecontrol-ecu -c compile -f
bitbake vehiclecontrol-ecu
bitbake vehiclecontrol-image
```

---

## 빌드 옵션

### 디버그 빌드
```bash
# devshell 진입 (수동 빌드/디버그)
bitbake vehiclecontrol-ecu -c devshell

# 빌드 로그 확인
bitbake vehiclecontrol-ecu -c compile -v
```

### 의존성 그래프 생성
```bash
bitbake -g vehiclecontrol-image
# task-depends.dot, pn-depends.dot 파일 생성됨
```

### 특정 태스크만 실행
```bash
# 사용 가능한 태스크 목록
bitbake vehiclecontrol-ecu -c listtasks

# fetch만 실행
bitbake vehiclecontrol-ecu -c fetch

# configure만 실행
bitbake vehiclecontrol-ecu -c configure
```

---

## 프로덕션 빌드

### 개발 도구 제거
`recipes-core/images/vehiclecontrol-image.bb` 수정:

```bitbake
# 디버그 도구 제거
IMAGE_INSTALL_remove = "gdbserver strace tcpdump vim"

# debug-tweaks 제거
IMAGE_FEATURES_remove = "debug-tweaks"

# 읽기 전용 루트 파일시스템
IMAGE_FEATURES_append = " read-only-rootfs"
```

### 보안 강화
```bitbake
# root 비밀번호 제거
EXTRA_USERS_PARAMS = ""

# SSH 포트 변경 또는 비활성화
IMAGE_FEATURES_remove = "ssh-server-openssh"
```

---

## 빌드 시간 단축

### shared state cache 활용
```bash
# conf/local.conf에 추가
SSTATE_DIR = "/path/to/shared/sstate-cache"
DL_DIR = "/path/to/shared/downloads"
```

### 병렬 빌드 최적화
```bash
# CPU 코어 수 확인
nproc

# conf/local.conf 설정
BB_NUMBER_THREADS = "$(nproc)"
PARALLEL_MAKE = "-j $(nproc)"
```

---

## 네트워크 설정 변경

### 고정 IP 변경
`recipes-core/systemd/files/10-eth0.network` 수정:

```ini
[Match]
Name=eth0

[Network]
Address=192.168.1.XXX/24  # 원하는 IP로 변경
```

### DHCP 사용
```ini
[Match]
Name=eth0

[Network]
DHCP=yes
```

---

## 추가 패키지 설치

### 이미지에 패키지 추가
`recipes-core/images/vehiclecontrol-image.bb` 수정:

```bitbake
IMAGE_INSTALL_append = " \
    nano \
    htop \
    curl \
"
```

### 새 recipe 추가
```bash
# 새 레이어 생성 또는 기존 레이어에 추가
mkdir -p recipes-support/mypackage
vi recipes-support/mypackage/mypackage_1.0.bb
```

---

## 빌드 정리

### 디스크 공간 확보
```bash
# 작업 디렉토리 정리
bitbake vehiclecontrol-image -c cleansstate

# 다운로드 캐시 정리 (주의!)
rm -rf ~/yocto/build-ecu1/downloads/*

# 전체 빌드 디렉토리 재생성
rm -rf ~/yocto/build-ecu1/tmp
bitbake vehiclecontrol-image
```

---

## 참고 자료

- [Yocto Project Documentation](https://docs.yoctoproject.org/4.0.1/)
- [BitBake User Manual](https://docs.yoctoproject.org/bitbake/2.0/)
- [meta-raspberrypi](https://github.com/agherzan/meta-raspberrypi)
