# 문제 해결 가이드

## 빌드 에러

### 1. "Nothing PROVIDES 'boost'"

**증상:**
```
ERROR: Nothing PROVIDES 'boost'
```

**원인:** meta-oe 레이어가 추가되지 않음

**해결:**
```bash
cd ~/yocto/build-ecu1
bitbake-layers add-layer ../meta-openembedded/meta-oe
bitbake vehiclecontrol-image
```

---

### 2. "vsomeip not found"

**증상:**
```
ERROR: vehiclecontrol-ecu do_configure: vsomeip not found
```

**원인:** vsomeip 빌드 실패 또는 의존성 문제

**해결:**
```bash
# vsomeip 클린 빌드
bitbake vsomeip -c cleanall
bitbake vsomeip

# 전체 재빌드
bitbake commonapi-core -c cleanall
bitbake commonapi-someip -c cleanall
bitbake vehiclecontrol-image
```

---

### 3. "Layer is not compatible"

**증상:**
```
ERROR: Layer meta-vehiclecontrol is not compatible with the core layer
```

**원인:** LAYERSERIES_COMPAT 불일치

**해결:**
```bash
# layer.conf 확인
cat /home/leo/SEA-ME/DES_Head-Unit/meta/meta-vehiclecontrol/conf/layer.conf

# kirkstone인지 확인
# LAYERSERIES_COMPAT_meta-vehiclecontrol = "kirkstone"

# 모든 레이어가 kirkstone 브랜치인지 확인
bitbake-layers show-layers
```

---

### 4. Git fetch 실패

**증상:**
```
ERROR: vsomeip: Unable to fetch URL
```

**원인:** 네트워크 문제 또는 Git 설정 문제

**해결:**
```bash
# 프록시 설정 (필요한 경우)
export http_proxy=http://proxy.example.com:8080
export https_proxy=http://proxy.example.com:8080

# Git 설정 확인
git config --global http.sslVerify false  # 임시 방편

# 수동으로 다운로드 테스트
git clone -b kirkstone https://github.com/COVESA/vsomeip.git
```

---

### 5. 디스크 공간 부족

**증상:**
```
ERROR: Insufficient space on disk
```

**해결:**
```bash
# 디스크 공간 확인
df -h

# 빌드 정리
cd ~/yocto/build-ecu1
rm -rf tmp/
rm -rf sstate-cache/

# 다운로드 캐시 정리 (주의!)
du -sh downloads/
rm -rf downloads/*
```

---

### 6. "Invalid override syntax"

**증상:**
```
ERROR: ParseError: Invalid override syntax
```

**원인:** Kirkstone에서는 `_` 사용, `:` 사용 불가

**해결:**
```bash
# recipe 파일 확인
grep -n "FILES:" recipes-*/*/*.bb

# : 를 _ 로 변경
# FILES:${PN} → FILES_${PN}
# RDEPENDS:${PN} → RDEPENDS_${PN}
```

---

## 런타임 에러

### 1. VehicleControlECU 서비스 시작 실패

**증상:**
```bash
systemctl status vehiclecontrol-ecu
● vehiclecontrol-ecu.service - VehicleControl ECU Service
   Loaded: loaded
   Active: failed
```

**진단:**
```bash
# 로그 확인
journalctl -u vehiclecontrol-ecu -n 50

# 수동 실행 테스트
export VSOMEIP_CONFIGURATION=/etc/vsomeip/vsomeip_ecu1.json
export COMMONAPI_CONFIG=/etc/commonapi/commonapi_ecu1.ini
/usr/bin/VehicleControlECU
```

**일반적인 원인:**
1. 설정 파일 누락
2. 라이브러리 의존성 문제
3. GPIO 권한 문제

**해결:**
```bash
# 1. 설정 파일 확인
ls -l /etc/vsomeip/vsomeip_ecu1.json
ls -l /etc/commonapi/commonapi_ecu1.ini

# 2. 라이브러리 확인
ldd /usr/bin/VehicleControlECU

# 3. GPIO 권한 확인
ls -l /dev/gpiomem
# root 또는 gpio 그룹 필요
```

---

### 2. I2C 장치 인식 안 됨

**증상:**
```bash
i2cdetect -y 1
Error: Could not open file '/dev/i2c-1'
```

**진단:**
```bash
# I2C 활성화 확인
ls -l /dev/i2c-*

# 커널 모듈 확인
lsmod | grep i2c

# dmesg 로그 확인
dmesg | grep i2c
```

**해결:**
```bash
# /boot/config.txt 확인 (재부팅 필요)
mount /dev/mmcblk0p1 /mnt
cat /mnt/config.txt | grep i2c

# 있어야 할 내용:
# dtparam=i2c_arm=on
# dtparam=i2c1=on

# 커널 모듈 수동 로드
modprobe i2c-dev
modprobe i2c-bcm2835
```

---

### 3. 네트워크 연결 안 됨

**증상:**
```bash
ping 192.168.1.100
# No response
```

**진단:**
```bash
# SSH로 접속 (시리얼 콘솔 필요)
# 또는 모니터 + 키보드 연결

# IP 주소 확인
ip addr show eth0

# 네트워크 인터페이스 상태
ip link show eth0

# 라우팅 테이블
ip route
```

**해결:**
```bash
# systemd-networkd 상태 확인
systemctl status systemd-networkd

# 네트워크 설정 파일 확인
cat /etc/systemd/network/10-eth0.network

# 수동 IP 설정 (임시)
ip addr add 192.168.1.100/24 dev eth0
ip link set eth0 up
```

---

### 4. vsomeip 통신 안 됨

**증상:**
- ECU2에서 ECU1 서비스 발견 안 됨
- Service Discovery 동작 안 함

**진단:**
```bash
# vsomeip 설정 확인
cat /etc/vsomeip/vsomeip_ecu1.json

# 멀티캐스트 라우팅 확인
ip route | grep 224

# 네트워크 인터페이스 확인
ip addr show eth0

# tcpdump로 패킷 확인
tcpdump -i eth0 port 30490 or port 30501
```

**해결:**
```bash
# 멀티캐스트 라우팅 추가
ip route add 224.0.0.0/4 dev eth0

# vsomeip 설정 수정
vi /etc/vsomeip/vsomeip_ecu1.json
# unicast, multicast 주소 확인

# 서비스 재시작
systemctl restart vehiclecontrol-ecu
```

---

### 5. pigpio 에러

**증상:**
```
Can't initialise pigpio library
```

**진단:**
```bash
# pigpio 라이브러리 확인
ls -l /usr/lib/libpigpio.so*

# GPIO 장치 확인
ls -l /dev/gpiomem
ls -l /dev/mem

# 권한 확인
id  # root여야 함
```

**해결:**
```bash
# pigpiod 데몬 실행 (대안)
pigpiod

# 또는 root로 실행
sudo /usr/bin/VehicleControlECU

# systemd 서비스는 이미 root로 설정됨
```

---

## 일반적인 문제

### 1. SD 카드 인식 안 됨

**해결:**
```bash
# SD 카드 포맷 (FAT32)
sudo mkfs.vfat -F 32 /dev/sdX1

# 재플래싱
sudo dd if=vehiclecontrol-image-*.rpi-sdimg of=/dev/sdX bs=4M
```

---

### 2. 부팅이 느림

**원인:**
- 첫 부팅 시 파일시스템 리사이징
- 네트워크 대기 시간

**해결:**
```bash
# 부팅 시간 분석
systemd-analyze
systemd-analyze blame

# 불필요한 서비스 비활성화
systemctl disable <service-name>
```

---

### 3. 로그 파일 가득 참

**해결:**
```bash
# 로그 크기 확인
journalctl --disk-usage

# 로그 정리
journalctl --vacuum-size=100M
journalctl --vacuum-time=7d

# 로그 제한 설정
vi /etc/systemd/journald.conf
# SystemMaxUse=100M
```

---

## 개발 팁

### devshell 사용
```bash
# recipe 환경에서 셸 실행
bitbake vehiclecontrol-ecu -c devshell

# 수동 빌드/테스트 가능
cd ${S}
cmake ${EXTRA_OECMAKE}
make
```

### 빠른 테스트
```bash
# 소스만 재빌드 (설정 변경 없을 때)
bitbake vehiclecontrol-ecu -c compile -f
bitbake vehiclecontrol-ecu
```

### 로그 레벨 조정
```bash
# vsomeip 디버그 로그
vi /etc/vsomeip/vsomeip_ecu1.json
# "level": "debug"

# systemd 로그 레벨
journalctl -u vehiclecontrol-ecu -p debug -f
```

---

## 도움 받기

### 로그 수집
```bash
# 시스템 정보
uname -a
cat /etc/os-release

# 빌드 로그
cat ~/yocto/build-ecu1/tmp/work/raspberrypi4_64-poky-linux/vehiclecontrol-ecu/1.0-r0/temp/log.do_compile

# 런타임 로그
journalctl -u vehiclecontrol-ecu --no-pager > vehiclecontrol-ecu.log
dmesg > dmesg.log
```

### 정보 공유 시 포함할 내용
1. 에러 메시지 전문
2. 관련 로그 파일
3. 수행한 단계
4. 시스템 환경 (Ubuntu 버전, Yocto 버전)
5. 수정한 파일 (있다면)
